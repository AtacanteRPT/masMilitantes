<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
<link rel="stylesheet" type="" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-dvf/0.3.1/css/dvf.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin="" />
<link rel="stylesheet" type="" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.css">
<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
    integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
    crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-dvf/0.3.1/leaflet-dvf.min.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-dvf/0.3.1/leaflet-dvf.markers.min.js"></script>



<style>
    html,
    body {
        height: 100%;
        margin: 0;
    }

    #map {
        width: 100%;
        height: 700px;
    }

    .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    .info h4 {
        margin: 0 0 5px;
        color: #777;
    }

    .legend {
        text-align: left;
        line-height: 18px;
        color: #555;
    }

    #map2 {
        width: 90%;
        height: 800px;
        box-shadow: 5px 5px 5px #888;

    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }

    .awesome-marker i {
        font-size: 18px;
        margin-top: 8px;
    }
</style>

<div class="container">
    <h1>Mapa de estadisticas</h1>
    <div id='map'></div>
</div> 


<div id="map2"></div>
<script>
    var circunscripcion7 = [
        [
            [-68.10489525139991, -16.550654151219554],
            [-68.10626778949366, -16.553945106104287],
            [-68.10043450259518, -16.55921051705157],
            [-68.10043450259518, -16.568095571759994],
            [-68.09460121569664, -16.573689655187746],
            [-68.08979733236849, -16.577967374017952],
            [-68.07298374071983, -16.574676829509045],
            [-68.07298374071983, -16.561514089101976],
            [-68.06474851215724, -16.554932381614144],
            [-68.05548388002434, -16.55624874109429],
            [-68.03969969194603, -16.551641443583783],
            [-68.02563117648494, -16.542755630321885],
            [-68.02254296577395, -16.529919844108537],
            [-68.02700371457868, -16.52234962135071],
            [-68.0338664050475, -16.51807066853448],
            [-68.04004282646946, -16.51576657776294],
            [-68.03283700147719, -16.510170814370632],
            [-68.03420953957097, -16.505562416998682],
            [-68.03764088480537, -16.498978801655433],
            [-68.0352389431413, -16.488115346488094],
            [-68.04759178598518, -16.490748967377257],
            [-68.05719955264153, -16.498320427795562],
            [-68.06474851215724, -16.500624726501577],
            [-68.0602877633525, -16.493711748041523],
            [-68.07641508595425, -16.49733286280449],
            [-68.0668073192979, -16.48844455105888],
            [-68.05925835978218, -16.474946704672927],
            [-68.07058179905574, -16.470995937545215],
            [-68.08430717999343, -16.47297133117842],
            [-68.10043450259518, -16.481531137513958],
            [-68.10626778949366, -16.47922661148039],
            [-68.11023553342459, -16.47938681076464],
            [-68.11143650425664, -16.48481885948554],
            [-68.11418158044415, -16.493048945942057],
            [-68.11555411853794, -16.504570478931623],
            [-68.11383844592072, -16.51378721110517],
            [-68.11521098401448, -16.51724337236287],
            [-68.11486784949105, -16.520534897037106],
            [-68.11761292567859, -16.520864046420066],
            [-68.121044270913, -16.517737104638975],
            [-68.12070113638954, -16.523168076396374],
            [-68.12584815424115, -16.528105190932134],
            [-68.13013733578417, -16.53353587111222],
            [-68.13425495006548, -16.542915776961827],
            [-68.12275994353018, -16.541105655201346],
            [-68.11383844592072, -16.545219543726855]
        ]
    ];
    var circunscripcion6 = [
        [
            [-68.1222219174818, -16.465629640233992],
            [-68.11450139070435, -16.46102018251545],
            [-68.10420735500112, -16.457233760274836],
            [-68.10043287524326, -16.452294837570623],
            [-68.1016338460753, -16.44636796436902],
            [-68.09854563536432, -16.443404459893774],
            [-68.09305548298927, -16.447520426112458],
            [-68.08533495621184, -16.440276267201394],
            [-68.07864383300473, -16.44356910021821],
            [-68.08018793836021, -16.451307037941483],
            [-68.09185451215721, -16.455752096666895],
            [-68.10334951869251, -16.468592805178815],
            [-68.10901123832929, -16.473037467653512],
            [-68.10557989309487, -16.476329744497896],
            [-68.11072691094651, -16.479292745819976],
            [-68.11501609248953, -16.491802696038306],
            [-68.11673176510672, -16.50497019111537],
            [-68.11518765975124, -16.51303483912572],
            [-68.11587392879812, -16.518795095972383],
            [-68.11844743772393, -16.519617975789128],
            [-68.1222219174818, -16.516655592046153],
            [-68.13045714604438, -16.49937411522376],
            [-68.13406005854053, -16.49822196185301],
            [-68.13766297103665, -16.49822196185301],
            [-68.1404080472242, -16.494107072372042],
            [-68.13406005854053, -16.485712426509377],
            [-68.13526102937256, -16.4791281358245],
            [-68.13646200020462, -16.47106207469451],
            [-68.13354535675535, -16.466946608023996],
            [-68.13131498235299, -16.46151405822686],
            [-68.12599639723965, -16.457233760274836],
            [-68.12445229188417, -16.46283105397417]
        ]
    ];
    var circunscripcion9 = [
        [
            [-68.13790806488092, -16.480515556396508],
            [-68.14734426427556, -16.47228493722399],
            [-68.14734426427556, -16.456810426817157],
            [-68.14168254463877, -16.44742634570602],
            [-68.14236881368565, -16.437053938678346],
            [-68.14550605258995, -16.43465479749831],
            [-68.14945209960952, -16.432020414630077],
            [-68.15562852103146, -16.43416085343186],
            [-68.15803046269555, -16.44782617581371],
            [-68.1607755388831, -16.456057833396862],
            [-68.16592255673471, -16.46445376426913],
            [-68.16695196030504, -16.469886231685688],
            [-68.16472158590268, -16.47795234176822],
            [-68.16266277876203, -16.481244535082105],
            [-68.16403531685579, -16.48256139673778],
            [-68.16712352756676, -16.481244535082105],
            [-68.16780979661364, -16.483878249438266],
            [-68.16883920018395, -16.48667653168996],
            [-68.17004017101601, -16.49177917754709],
            [-68.16540785494954, -16.496223307873183],
            [-68.16352061507061, -16.500338152343],
            [-68.15888829900416, -16.496670066830482],
            [-68.15202560853534, -16.48876933837692],
            [-68.14584918711338, -16.49206134776574],
            [-68.14035903473832, -16.493213537822687],
            [-68.1352120168867, -16.485477272999574],
            [-68.13572671867185, -16.480539069976757]
        ]
    ];
    var circunscripcion8 = [
        [
            [-68.15183662995561, -16.490579950469982],
            [-68.1532091680494, -16.492390545624872],
            [-68.15835618590098, -16.49732844630696],
            [-68.16333163649091, -16.5011140848132],
            [-68.15698364780724, -16.50802679871313],
            [-68.1525228990025, -16.512964300178542],
            [-68.14806215019776, -16.520864040142058],
            [-68.14737588115088, -16.528105184654343],
            [-68.14737588115088, -16.531396524213335],
            [-68.1490915537681, -16.53501693291287],
            [-68.15132192817046, -16.536168866893654],
            [-68.15286603352594, -16.53830815461501],
            [-68.14943468829154, -16.54127020614952],
            [-68.14222886329924, -16.541599320179493],
            [-68.13519460556871, -16.54291577068453],
            [-68.13296423116635, -16.536004305317363],
            [-68.13004758771709, -16.531067392782536],
            [-68.12541527165064, -16.525142931079525],
            [-68.1219839264162, -16.522345205424724],
            [-68.12318489724825, -16.516914210533052],
            [-68.12884661688504, -16.505064237301504],
            [-68.13193482759603, -16.50062031007921],
            [-68.13691027818591, -16.499468164131176],
            [-68.14085632520549, -16.495682493414858],



            [-68.1434298341313, -16.494036526520404],
            [-68.14943468829154, -16.49156754992707]
        ]
    ];
</script>

<script src="/js/geoJsonDistritos.js"></script>
<script>

    var auxRecintos = <%- JSON.stringify(recintos) %>;
    var auxZonas = <%- JSON.stringify(zonas) %>;
    var auxDistritos = <%- JSON.stringify(distritos) %>;
    var auxCircunscripciones = <%- JSON.stringify(circunscripciones) %>;
    var statesData = {
        "type": "FeatureCollection",
        "features": [{
            "type": "Feature",
            "id": "01",
            "properties": {
                "name": "Circunscripción 6",
                "id": 3,
                "density": 94.65
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": circunscripcion6,

            }
        }, {
            "type": "Feature",
            "id": "01",
            "properties": {
                "name": "Circunscripción 7",
                "id": 2,
                "density": 300.65
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": circunscripcion7,

            }
        }, {
            "type": "Feature",
            "id": "01",
            "properties": {
                "name": "Circunscripción 8",
                "id": 1,
                "density": 100.65
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": circunscripcion8,

            }
        }, {
            "type": "Feature",
            "id": "01",
            "properties": {
                "name": "Circunscripción 9",
                "id": 4,
                "density": 700.65
            },
            "geometry": {
                "type": "Polygon",
                "coordinates": circunscripcion9,

            }
        }]
    }

    var map = L.map('map').setView([-16.51773269488567, -68.11798095703126], 12);

    // L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '',
        id: 'mapbox.light'
    }).addTo(map);


    // control that shows state info on hover
    var info = L.control();

    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
    };

    info.update = function (props) {
        if (props) {
            var distritos = auxDistritos.filter(dato => dato.idCircunscripcion == props.id);
            var textDistritos = '';
            distritos.forEach(function (element) {

                textDistritos += '<p>' + element.nombre + '</p>'
            }, this);

        }


        this._div.innerHTML = '<h4>Concentración de votos</h4>' + (props ?
            '<b>' + props.name + '</b><br />' + ' Distritos' +
            textDistritos :
            'circunscripciones');
    };

    info.addTo(map);


    // get color depending on population density value
    function getColor(d) {
        return d > 1000 ? '#800026' :
            d > 500 ? '#BD0026' :
                d > 200 ? '#E31A1C' :
                    d > 100 ? '#29088A' :
                        d > 50 ? '#FD8D3C' :
                            d > 20 ? '#FEB24C' :
                                d > 10 ? '#FED976' :
                                    '#FFEDA0';
    }

    function style(feature) {
        return {
            weight: 2,
            opacity: 1,
            color: 'black',
            dashArray: '5',
            fillOpacity: 0.2,
            fillColor: getColor(feature.properties.density)
        };
    }

    function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
            weight: 5,
            color: '#666',
            dashArray: '',
            fillOpacity: 0.7
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }

        info.update(layer.feature.properties);
    }

    var geojson;

    function resetHighlight(e) {
        geojson.resetStyle(e.target);
        info.update();
    }

    function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            // click: zoomToFeature
        });
    }

    geojson = L.geoJson(geoDistritos, {
        style: style,
        onEachFeature: onEachFeature
    }).addTo(map);

    map.attributionControl.addAttribution('');


    var legend = L.control({
        position: 'bottomright'
    });

    legend.onAdd = function (map) {

        var div = L.DomUtil.create('div', 'info legend'),
            grades = [0, 10, 20, 50, 100, 300, 500, 1000],
            labels = [],
            from, to;
        labels.push('Concentración ');

        labels.push('<i style="background:green"></i> ' +
            '&ndash; Alta');
        labels.push('<i style="background:blue"></i> ' +
            '&ndash; Media');
        labels.push('<i style="background:red"></i> ' +
            '&ndash; Baja');


        div.innerHTML = labels.join('<br>');
        return div;
    };

    legend.addTo(map);

    // var squareRedMarker = L.AwesomeMarkers.icon({
    //     icon: 'coffee',
    //     markerColor: 'red',
    //     className: 'awesome-marker awesome-marker-square'
    // });

    var verdeIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    var azulIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var rojoIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
var auxMarca = {};
    auxRecintos.forEach(function (recinto) {
 

        ///////////////////////////////// INICIO ///////////////////////////////////

        if (recinto.latitud != null || recinto.longitud != null) {
            var sw = false;
            auxMarca['marca-' + recinto.id] = L.marker([recinto.latitud, recinto.longitud], {
                icon: rojoIcon
            }).addTo(map);

            // console.log('COLLAPSE', collapse)
            auxMarca['marca-' + recinto.id].bindPopup(
                '<p>'+recinto.nombre+'</p>', {
                    closeOnClick: false,
                    autoClose: false,
                    // minWdth: '1000',
                    maxWidth: 'auto',
                    // autoPan: true,
                    // className: 'custom'
                }).openPopup()
        }


        ///////////////////////////////////FIN /////////////////////////////////


    }, this);




    // Initialise the FeatureGroup to store editable layers
    var editableLayers = new L.FeatureGroup();
    map.addLayer(editableLayers);

    var drawPluginOptions = {
        position: 'topright',
        draw: {
            polygon: {
                allowIntersection: false, // Restricts shapes to simple polygons
                drawError: {
                    color: '#e1e100', // Color the shape will turn when intersects
                    message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
                },
                shapeOptions: {
                    color: '#97009c'
                }
            },
            // disable toolbar item by setting it to false
            polyline: false,
            circle: false, // Turns off this drawing tool
            rectangle: false,
            marker: false,
        },
        edit: {
            featureGroup: editableLayers, //REQUIRED!!
            remove: false
        }
    };

    // Initialise the draw control and pass it the FeatureGroup of editable layers
    var drawControl = new L.Control.Draw(drawPluginOptions);
    map.addControl(drawControl);

    var editableLayers = new L.FeatureGroup();
    map.addLayer(editableLayers);

    map.on('draw:created', function (e) {
        console.log("EVENTo", e.layer)
        var type = e.layerType,
            layer = e.layer;
        // console.log("ARRAY", JSON.stringify(e.layer._latlngs));
        if (type === 'marker') {
            layer.bindPopup('A popup!');
        }
        var auxDistrito = [];
        e.layer._latlngs[0].forEach(element => {
            auxDistrito.push([element.lng, element.lat]);
        });

        console.log(JSON.stringify([auxDistrito]));
        editableLayers.addLayer(layer);
    });



</script>

<script>
    // center of the map
    var center = [-16.54228478135609, -68.0638515483588];

    // Create the map
    var map2 = L.map('map2').setView(center, 12);

    // Set up the OSM layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        // L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {

        attribution: 'Data © <a href="http://osm.org/copyright">OpenStreetMap</a>',
        maxZoom: 18,
        // id: 'mapbox.light'
    }).addTo(map2);

    // add a marker in the given location
    var lilaIcon = new L.Icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    var auxMarca = {};
    auxRecintos.forEach(function (recinto) {
 

        ///////////////////////////////// INICIO ///////////////////////////////////

        if (recinto.latitud != null || recinto.longitud != null) {
            var sw = false;
            auxMarca['marca-' + recinto.id] = L.marker([recinto.latitud, recinto.longitud], {
                icon: lilaIcon
            }).addTo(map2);

            // console.log('COLLAPSE', collapse)
            auxMarca['marca-' + recinto.id].bindPopup(
                '<p>'+recinto.nombre+'</p>', {
                    closeOnClick: false,
                    autoClose: false,
                    // minWdth: '1000',
                    maxWidth: 'auto',
                    // autoPan: true,
                    // className: 'custom'
                }).openPopup()
        }


        ///////////////////////////////////FIN /////////////////////////////////


    }, this);




    // Initialise the FeatureGroup to store editable layers
    var editableLayers = new L.FeatureGroup();
    map2.addLayer(editableLayers);

    var drawPluginOptions = {
        position: 'topright',
        draw: {
            polygon: {
                allowIntersection: false, // Restricts shapes to simple polygons
                drawError: {
                    color: '#e1e100', // Color the shape will turn when intersects
                    message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
                },
                shapeOptions: {
                    color: '#97009c'
                }
            },
            // disable toolbar item by setting it to false
            polyline: false,
            circle: false, // Turns off this drawing tool
            rectangle: false,
            marker: false,
        },
        edit: {
            featureGroup: editableLayers, //REQUIRED!!
            remove: false
        }
    };

    // Initialise the draw control and pass it the FeatureGroup of editable layers
    var drawControl = new L.Control.Draw(drawPluginOptions);
    map2.addControl(drawControl);

    var editableLayers = new L.FeatureGroup();
    map2.addLayer(editableLayers);

    map2.on('draw:created', function (e) {
        console.log("EVENTo", e.layer)
        var type = e.layerType,
            layer = e.layer;
        // console.log("ARRAY", JSON.stringify(e.layer._latlngs));
        if (type === 'marker') {
            layer.bindPopup('A popup!');
        }
        var auxDistrito = [];
        e.layer._latlngs[0].forEach(element => {
            auxDistrito.push([element.lng, element.lat]);
        });

        console.log(JSON.stringify([auxDistrito]));
        editableLayers.addLayer(layer);
    });
</script>